{% extends 'base.html' %}
{% load humanize %}

{% block title %}Due Collection Report{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-money-bill-wave text-success"></i> Due Collection Report
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'customer_due_report' %}" class="btn btn-sm btn-outline-danger me-2">
            <i class="fas fa-file-invoice-dollar"></i> Due Report
        </a>
        <button class="btn btn-sm btn-outline-secondary" onclick="window.print()">
            <i class="fas fa-print"></i> Print
        </button>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">
            <i class="fas fa-filter"></i> Filters
        </h6>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Search Customer</label>
                <input type="text" class="form-control" name="customer" value="{{ filters.customer }}" 
                       placeholder="Name or phone...">
            </div>
            <div class="col-md-2">
                <label class="form-label">Date From</label>
                <input type="date" class="form-control" name="date_from" value="{{ filters.date_from }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Date To</label>
                <input type="date" class="form-control" name="date_to" value="{{ filters.date_to }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Payment Method</label>
                <select class="form-select" name="payment_method">
                    <option value="">All Methods</option>
                    <option value="cash" {% if filters.payment_method == 'cash' %}selected{% endif %}>Cash</option>
                    <option value="bank" {% if filters.payment_method == 'bank' %}selected{% endif %}>Bank</option>
                    <option value="check" {% if filters.payment_method == 'check' %}selected{% endif %}>Check</option>
                    <option value="digital" {% if filters.payment_method == 'digital' %}selected{% endif %}>Digital</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-flex gap-1">
                    <button type="submit" class="btn btn-primary flex-fill">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <a href="{% url 'due_collection_report' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-redo"></i> Reset
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h6 class="card-title">Total Payments</h6>
                <h3>{{ total_payments }}</h3>
                <small>Transactions</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h6 class="card-title">Total Collected</h6>
                <h3>৳{{ total_collected|floatformat:2|intcomma }}</h3>
                <small>Amount Collected</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h6 class="card-title">Average Payment</h6>
                <h3>৳{{ average_payment|floatformat:2|intcomma }}</h3>
                <small>Per transaction</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h6 class="card-title">Collection Period</h6>
                <h6>{{ start_date }} to {{ today }}</h6>
                <small>Last 30 days</small>
            </div>
        </div>
    </div>
</div>

<!-- Payment Method Breakdown -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Payment Methods</h6>
            </div>
            <div class="card-body">
                {% for method in payment_methods %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-secondary">{{ method.payment_method|title }}</span>
                    <div class="text-end">
                        <strong>৳{{ method.total_amount|floatformat:2|intcomma }}</strong>
                        <br>
                        <small class="text-muted">{{ method.payment_count }} payments</small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Top Customers</h6>
            </div>
            <div class="card-body">
                {% for customer in top_customers %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small>{{ customer.customer__name }}</small>
                    <div class="text-end">
                        <strong>৳{{ customer.total_paid|floatformat:2|intcomma }}</strong>
                        <br>
                        <small class="text-muted">{{ customer.payment_count }} payments</small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Collection Chart -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">Daily Collection Trend (Last 30 Days)</h6>
    </div>
    <div class="card-body">
        <canvas id="collectionChart" height="100"></canvas>
    </div>
</div>

<!-- Payments Table -->
<div class="card">
    <div class="card-header">
        <h6 class="card-title mb-0">
            Payment Collection Details 
            <small class="text-muted">(Showing {{ payments|length }} of {{ total_payments }} payments)</small>
        </h6>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Received By</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                    <tr>
                        <td>{{ payment.payment_date|date:"M d, Y H:i" }}</td>
                        <td>
                            <strong>{{ payment.customer.name }}</strong>
                            <br><small class="text-muted">{{ payment.customer.phone }}</small>
                        </td>
                        <td class="text-success fw-bold">
                            ৳{{ payment.amount|floatformat:2|intcomma }}
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ payment.get_payment_method_display }}</span>
                        </td>
                        <td>{{ payment.received_by.get_full_name|default:payment.received_by.username }}</td>
                        <td>
                            {% if payment.notes %}
                            <small class="text-muted">{{ payment.notes|truncatewords:5 }}</small>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" 
                                    onclick="viewCustomerDetails({{ payment.customer.id }})"
                                    title="View Customer">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <p>No payments found matching your criteria</p>
                            <a href="{% url 'due_collection_report' %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-redo"></i> Reset Filters
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if payments.has_other_pages %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if payments.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">First</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ payments.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
        </li>
        {% endif %}

        {% for num in payments.paginator.page_range %}
            {% if payments.number == num %}
            <li class="page-item active">
                <span class="page-link">{{ num }}</span>
            </li>
            {% elif num > payments.number|add:'-3' and num < payments.number|add:'3' %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
            </li>
            {% endif %}
        {% endfor %}

        {% if payments.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ payments.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ payments.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Last</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Collection Chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('collectionChart');
    if (ctx) {
        const collectionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ daily_labels|safe }},
                datasets: [{
                    label: 'Daily Collection',
                    data: {{ daily_data|safe }},
                    backgroundColor: 'rgba(40, 167, 69, 0.8)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Amount (৳)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });
    }
});

function viewCustomerDetails(customerId) {
    window.open('/customer-due-report/?customer=' + customerId, '_blank');
}
</script>
{% endblock %}