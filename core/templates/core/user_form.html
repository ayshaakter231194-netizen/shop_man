{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Edit User{% else %}Create New User{% endif %} - Shop Management
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas {% if form.instance.pk %}fa-user-edit{% else %}fa-user-plus{% endif %}"></i>
        {% if form.instance.pk %}Edit User{% else %}Create New User{% endif %}
    </h1>
</div>

<!-- Debug Messages -->
{% if messages %}
<div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="row">
    <!-- User Form -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user-circle"></i> User Information
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="userForm" novalidate>
                    {% csrf_token %}
                    
                    <!-- Debug CSRF -->
                    <input type="hidden" name="debug_info" value="form_submission">
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        <h6>Form Errors:</h6>
                        {% for error in form.non_field_errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Field-specific Errors -->
                    {% for field in form %}
                        {% if field.errors %}
                        <div class="alert alert-warning">
                            <strong>{{ field.label }}:</strong>
                            {% for error in field.errors %}
                                <div>{{ error }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    {% endfor %}

                    <!-- Basic Information -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.username.id_for_label }}" class="form-label">
                                Username <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   name="{{ form.username.name }}" 
                                   class="form-control {% if form.username.errors %}is-invalid{% endif %}" 
                                   id="{{ form.username.id_for_label }}" 
                                   value="{{ form.username.value|default:'' }}"
                                   required
                                   placeholder="Enter username">
                            {% if form.username.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.username.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">
                                Email Address <span class="text-danger">*</span>
                            </label>
                            <input type="email" 
                                   name="{{ form.email.name }}" 
                                   class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                                   id="{{ form.email.id_for_label }}" 
                                   value="{{ form.email.value|default:'' }}"
                                   required
                                   placeholder="Enter email address">
                            {% if form.email.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.email.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.first_name.id_for_label }}" class="form-label">
                                First Name
                            </label>
                            <input type="text" 
                                   name="{{ form.first_name.name }}" 
                                   class="form-control {% if form.first_name.errors %}is-invalid{% endif %}" 
                                   id="{{ form.first_name.id_for_label }}" 
                                   value="{{ form.first_name.value|default:'' }}"
                                   placeholder="Enter first name">
                            {% if form.first_name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.first_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.last_name.id_for_label }}" class="form-label">
                                Last Name
                            </label>
                            <input type="text" 
                                   name="{{ form.last_name.name }}" 
                                   class="form-control {% if form.last_name.errors %}is-invalid{% endif %}" 
                                   id="{{ form.last_name.id_for_label }}" 
                                   value="{{ form.last_name.value|default:'' }}"
                                   placeholder="Enter last name">
                            {% if form.last_name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.last_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Password Fields -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_password1" class="form-label">
                                {% if form.instance.pk %}New Password{% else %}Password{% endif %}
                                {% if not form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            <input type="password" 
                                   name="password1" 
                                   class="form-control" 
                                   id="id_password1" 
                                   {% if not form.instance.pk %}required{% endif %}
                                   placeholder="{% if form.instance.pk %}Leave blank to keep current password{% else %}Enter password{% endif %}"
                                   autocomplete="new-password">
                            <div class="form-text">
                                <ul class="small mb-0 ps-3">
                                    <li>Your password can't be too similar to your other personal information.</li>
                                    <li>Your password must contain at least 8 characters.</li>
                                    <li>Your password can't be a commonly used password.</li>
                                    <li>Your password can't be entirely numeric.</li>
                                </ul>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="id_password2" class="form-label">
                                {% if form.instance.pk %}Confirm New Password{% else %}Confirm Password{% endif %}
                                {% if not form.instance.pk %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            <input type="password" 
                                   name="password2" 
                                   class="form-control" 
                                   id="id_password2" 
                                   {% if not form.instance.pk %}required{% endif %}
                                   placeholder="{% if form.instance.pk %}Confirm new password{% else %}Enter same password again{% endif %}"
                                   autocomplete="new-password">
                            <div class="form-text">
                                Enter the same password as before, for verification.
                            </div>
                        </div>
                    </div>

                    <!-- Password Strength Meter -->
                    <div class="row mb-3" id="passwordStrength" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body py-2">
                                    <small class="text-muted">Password Strength:</small>
                                    <div class="progress mt-1" style="height: 5px;">
                                        <div class="progress-bar" id="passwordStrengthBar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="passwordStrengthText">Very Weak</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Role and Permissions -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.role.id_for_label }}" class="form-label">
                                User Role <span class="text-danger">*</span>
                            </label>
                            <select name="{{ form.role.name }}" 
                                    class="form-select {% if form.role.errors %}is-invalid{% endif %}" 
                                    id="{{ form.role.id_for_label }}" 
                                    required>
                                <option value="">Select Role</option>
                                {% for role_value, role_name in form.role.field.choices %}
                                    {% if role_value %}
                                    <option value="{{ role_value }}" 
                                            {% if form.role.value == role_value %}selected{% endif %}>
                                        {{ role_name }}
                                    </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            {% if form.role.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.role.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Select the appropriate role for this user.
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.is_active.id_for_label }}" class="form-label">Account Status</label>
                            <div class="form-control bg-light">
                                <div class="form-check form-switch mb-0">
                                    <input type="checkbox" 
                                           name="{{ form.is_active.name }}" 
                                           class="form-check-input" 
                                           id="{{ form.is_active.id_for_label }}" 
                                           {% if form.is_active.value %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                        Active Account
                                    </label>
                                </div>
                            </div>
                            <div class="form-text">
                                Inactive users cannot log into the system.
                            </div>
                        </div>
                    </div>

                    <!-- Admin Access -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="form-control bg-light">
                                <div class="form-check form-switch mb-0">
                                    <input type="checkbox" 
                                           name="{{ form.is_system_admin.name }}" 
                                           class="form-check-input" 
                                           id="{{ form.is_system_admin.id_for_label }}" 
                                           {% if form.is_system_admin.value %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ form.is_system_admin.id_for_label }}">
                                        <strong>System Administrator Access</strong>
                                    </label>
                                </div>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                                System administrators can access Django admin and manage all users. 
                                Only grant this to trusted users.
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.phone.id_for_label }}" class="form-label">Phone Number</label>
                            <input type="text" 
                                   name="{{ form.phone.name }}" 
                                   class="form-control {% if form.phone.errors %}is-invalid{% endif %}" 
                                   id="{{ form.phone.id_for_label }}" 
                                   value="{{ form.phone.value|default:'' }}"
                                   placeholder="Enter phone number">
                            {% if form.phone.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.phone.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                Optional phone number for contact purposes.
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Last Login</label>
                            <div class="form-control bg-light">
                                {% if form.instance.last_login %}
                                    {{ form.instance.last_login|date:"M d, Y H:i" }}
                                {% else %}
                                    <span class="text-muted">Never logged in</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Address -->
                    <div class="mb-3">
                        <label for="{{ form.address.id_for_label }}" class="form-label">Address</label>
                        <textarea name="{{ form.address.name }}" 
                                  class="form-control {% if form.address.errors %}is-invalid{% endif %}" 
                                  id="{{ form.address.id_for_label }}" 
                                  rows="3"
                                  placeholder="Enter address">{{ form.address.value|default:'' }}</textarea>
                        {% if form.address.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.address.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- View Permissions Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-eye"></i> View Permissions
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                Select the views this user can access. System administrators automatically get access to all views.
                            </div>
                            
                            <div class="row">
                                {% for category, views in view_categories %}
                                <div class="col-md-6 mb-3">
                                    <h6 class="border-bottom pb-2 text-primary">
                                        <i class="fas fa-folder"></i> {{ category }}
                                    </h6>
                                    {% for view in views %}
                                    <div class="form-check mb-2">
                                        <input class="form-check-input view-permission-checkbox" 
                                               type="checkbox" 
                                               name="view_permissions" 
                                               value="{{ view.view_code }}"
                                               id="perm_{{ view.view_code }}"
                                               {% if view in user_view_permissions %}checked{% endif %}>
                                        <label class="form-check-label" for="perm_{{ view.view_code }}">
                                            <strong>{{ view.name }}</strong>
                                        </label>
                                        {% if view.description %}
                                        <small class="form-text text-muted d-block">{{ view.description }}</small>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Permission Control Buttons -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAllPermissions()">
                                            <i class="fas fa-check-square"></i> Select All
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="deselectAllPermissions()">
                                            <i class="fas fa-square"></i> Select None
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="selectCommonPermissions()">
                                            <i class="fas fa-user-tie"></i> Common Permissions
                                        </button>
                                    </div>
                                    <div class="btn-group ms-2" role="group">
                                        <button type="button" class="btn btn-outline-success btn-sm" onclick="applyRolePreset('admin')">
                                            <i class="fas fa-crown"></i> Admin Preset
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="applyRolePreset('manager')">
                                            <i class="fas fa-user-tie"></i> Manager Preset
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="applyRolePreset('sales')">
                                            <i class="fas fa-cash-register"></i> Sales Preset
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Selected Permissions Summary -->
                            <div class="card mt-3" id="permissionsSummaryCard" style="display: none;">
                                <div class="card-header py-2">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-list-check"></i> Selected Permissions Summary
                                        <span class="badge bg-primary ms-2" id="selectedPermissionsCount">0</span>
                                    </h6>
                                </div>
                                <div class="card-body py-2">
                                    <div id="selectedPermissionsList" class="small">
                                        <!-- Selected permissions will be listed here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-success w-100" id="submitBtn">
                                <i class="fas fa-save"></i>
                                {% if form.instance.pk %}Update User{% else %}Create User{% endif %}
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-warning w-100" id="resetBtn">
                                <i class="fas fa-undo"></i> Reset Form
                            </button>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'user_management' %}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Role Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> Role Descriptions
                </h6>
            </div>
            <div class="card-body">
                {% for role_value, role_name in form.role.field.choices %}
                    {% if role_value %}
                    <div class="mb-3">
                        <h6 class="{% cycle 'text-primary' 'text-success' 'text-info' 'text-warning' 'text-secondary' %}">
                            <i class="fas 
                                {% if role_value == 'admin' %}fa-crown
                                {% elif role_value == 'manager' %}fa-user-tie
                                {% elif role_value == 'sales' %}fa-cash-register
                                {% elif role_value == 'purchase' %}fa-shopping-cart
                                {% else %}fa-user{% endif %}
                            "></i> {{ role_name }}
                        </h6>
                        <small class="text-muted">
                            {% if role_value == 'admin' %}
                                Full system access. Can manage all users, settings, and data.
                            {% elif role_value == 'manager' %}
                                Can manage products, sales, purchases, and view all reports.
                            {% elif role_value == 'sales' %}
                                Can process sales, view products, and access sales reports.
                            {% elif role_value == 'purchase' %}
                                Can manage purchase orders, suppliers, and inventory.
                            {% else %}
                                Basic access. Can view products and limited reports.
                            {% endif %}
                        </small>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Permission Presets -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-magic"></i> Permission Presets
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="applyRolePreset('admin')">
                        <i class="fas fa-crown"></i> Administrator Preset
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="applyRolePreset('manager')">
                        <i class="fas fa-user-tie"></i> Manager Preset
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="applyRolePreset('sales')">
                        <i class="fas fa-cash-register"></i> Sales Preset
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="applyRolePreset('purchase')">
                        <i class="fas fa-shopping-cart"></i> Purchase Preset
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="applyRolePreset('staff')">
                        <i class="fas fa-user"></i> Staff Preset
                    </button>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Tip:</strong> Select a role first, then apply the corresponding preset for quick setup.
                    </small>
                </div>
            </div>
        </div>

        <!-- User Statistics -->
        {% if form.instance.pk %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-bar"></i> User Statistics
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block">Total Sales</small>
                            <strong class="text-primary">{{ user_sales_count|default:0 }}</strong>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block">Last Activity</small>
                            <small>
                                {% if form.instance.last_login %}
                                    {{ form.instance.last_login|timesince }} ago
                                {% else %}
                                    Never
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info">
                    <small>
                        <i class="fas fa-info-circle"></i>
                        <strong>User since:</strong> {{ form.instance.date_joined|date:"M d, Y" }}
                    </small>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="generateUsername()">
                        <i class="fas fa-magic"></i> Generate Username
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="generatePassword()">
                        <i class="fas fa-key"></i> Generate Password
                    </button>
                    {% if form.instance.pk %}
                    <button type="button" class="btn btn-outline-warning" onclick="sendResetLink()">
                        <i class="fas fa-envelope"></i> Send Reset Link
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="showAccessLog()">
                        <i class="fas fa-history"></i> Access Log
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Security Tips -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-shield-alt"></i> Security Tips
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <ul class="small mb-0 ps-3">
                        <li>Always assign the minimum required permissions</li>
                        <li>Use strong, unique passwords</li>
                        <li>Regularly review user access levels</li>
                        <li>Deactivate unused accounts promptly</li>
                        <li>Only grant admin access to trusted users</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Access Log Modal -->
<div class="modal fade" id="accessLogModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Access Log - {{ form.instance.username }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Access log functionality would be implemented here.
                </div>
                <p>This would show:</p>
                <ul>
                    <li>Login history and IP addresses</li>
                    <li>Password change history</li>
                    <li>Recent activities and actions</li>
                    <li>Security events and alerts</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Role permissions mapping
const rolePermissions = {
    'admin': {
        name: 'Administrator',
        permissions: [
            'Full system access',
            'User management',
            'System configuration',
            'All reports and analytics',
            'Database maintenance'
        ],
        color: 'text-primary'
    },
    'manager': {
        name: 'Manager',
        permissions: [
            'Product management',
            'Sales and purchase access',
            'Stock management',
            'All reports access',
            'Staff supervision'
        ],
        color: 'text-success'
    },
    'sales': {
        name: 'Sales Person',
        permissions: [
            'Point of Sale (POS)',
            'Product viewing',
            'Sales reports',
            'Customer management',
            'Limited stock viewing'
        ],
        color: 'text-info'
    },
    'purchase': {
        name: 'Purchase Manager',
        permissions: [
            'Purchase order management',
            'Supplier management',
            'Inventory management',
            'Purchase reports',
            'Stock adjustment'
        ],
        color: 'text-warning'
    },
    'staff': {
        name: 'Staff',
        permissions: [
            'Basic product viewing',
            'Limited report access',
            'No financial data',
            'No user management',
            'No system settings'
        ],
        color: 'text-secondary'
    }
};

// Role permission presets
const rolePermissionPresets = {
    'admin': [
        'dashboard', 'product_list', 'product_create', 'product_edit', 'product_delete',
        'stock_adjustment', 'stock_report', 'expiry_report', 'batch_management',
        'pos_sale', 'daily_sale_report', 'profit_report', 'sale_return_list',
        'purchase_order_create', 'purchase_report', 'purchase_return_list',
        'supplier_bills', 'bill_dashboard',
        'customer_management', 'customer_due_report', 'due_collection_report',
        'generate_sales_report', 'user_management'
    ],
    'manager': [
        'dashboard', 'product_list', 'product_create', 'product_edit',
        'stock_report', 'expiry_report', 'batch_management',
        'pos_sale', 'daily_sale_report', 'profit_report', 'sale_return_list',
        'purchase_report', 'purchase_return_list',
        'supplier_bills', 'bill_dashboard',
        'customer_management', 'customer_due_report', 'due_collection_report',
        'generate_sales_report'
    ],
    'sales': [
        'dashboard', 'product_list', 'pos_sale', 'daily_sale_report',
        'customer_management', 'customer_due_report'
    ],
    'purchase': [
        'dashboard', 'product_list', 'stock_report', 'expiry_report',
        'purchase_order_create', 'purchase_report', 'purchase_return_list',
        'supplier_bills', 'bill_dashboard'
    ],
    'staff': [
        'dashboard', 'product_list', 'pos_sale'
    ]
};

// Common permissions for quick selection
const commonPermissions = [
    'dashboard', 'product_list', 'stock_report', 'pos_sale', 'daily_sale_report'
];

// Update permissions summary when role changes
document.getElementById('{{ form.role.id_for_label }}').addEventListener('change', function() {
    const role = this.value;
    const summaryElement = document.getElementById('permissionsSummary');
    
    if (role && rolePermissions[role]) {
        const roleInfo = rolePermissions[role];
        let html = `
            <h6 class="${roleInfo.color}">
                <i class="fas fa-user-shield"></i> ${roleInfo.name}
            </h6>
            <ul class="small mb-0">
        `;
        
        roleInfo.permissions.forEach(permission => {
            html += `<li>${permission}</li>`;
        });
        
        html += `</ul>`;
        if (summaryElement) {
            summaryElement.innerHTML = html;
        }
    } else if (summaryElement) {
        summaryElement.innerHTML = '<p class="text-muted mb-0">Select a role to view permissions...</p>';
    }
});

// Permission management functions
function selectAllPermissions() {
    document.querySelectorAll('.view-permission-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    updatePermissionsSummary();
    showNotification('All permissions selected!', 'info');
}

function deselectAllPermissions() {
    document.querySelectorAll('.view-permission-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updatePermissionsSummary();
    showNotification('All permissions deselected!', 'info');
}

function selectCommonPermissions() {
    deselectAllPermissions();
    commonPermissions.forEach(perm => {
        const checkbox = document.querySelector(`input[name="view_permissions"][value="${perm}"]`);
        if (checkbox) checkbox.checked = true;
    });
    updatePermissionsSummary();
    showNotification('Common permissions selected!', 'info');
}

function applyRolePreset(role) {
    if (role in rolePermissionPresets) {
        deselectAllPermissions();
        rolePermissionPresets[role].forEach(perm => {
            const checkbox = document.querySelector(`input[name="view_permissions"][value="${perm}"]`);
            if (checkbox) checkbox.checked = true;
        });
        
        // Also update the role dropdown
        const roleDropdown = document.getElementById('{{ form.role.id_for_label }}');
        if (roleDropdown) {
            roleDropdown.value = role;
        }
        
        updatePermissionsSummary();
        showNotification(`${role.charAt(0).toUpperCase() + role.slice(1)} permissions preset applied!`, 'success');
    }
}

function updatePermissionsSummary() {
    const selectedCheckboxes = document.querySelectorAll('.view-permission-checkbox:checked');
    const count = selectedCheckboxes.length;
    const summaryCard = document.getElementById('permissionsSummaryCard');
    const countElement = document.getElementById('selectedPermissionsCount');
    const listElement = document.getElementById('selectedPermissionsList');
    
    if (countElement) {
        countElement.textContent = count;
    }
    
    if (summaryCard) {
        if (count > 0) {
            summaryCard.style.display = 'block';
            let html = '<div class="row">';
            
            // Group permissions by category for better display
            const categories = {};
            selectedCheckboxes.forEach(checkbox => {
                const categoryElement = checkbox.closest('.col-md-6');
                if (categoryElement) {
                    const categoryTitle = categoryElement.querySelector('h6').textContent.trim();
                    const permissionName = checkbox.nextElementSibling.querySelector('strong').textContent;
                    
                    if (!categories[categoryTitle]) {
                        categories[categoryTitle] = [];
                    }
                    categories[categoryTitle].push(permissionName);
                }
            });
            
            // Display by category
            Object.keys(categories).forEach(category => {
                html += `<div class="col-md-6 mb-2">`;
                html += `<strong class="text-primary">${category}:</strong><br>`;
                html += `<small>${categories[category].join(', ')}</small>`;
                html += `</div>`;
            });
            
            html += '</div>';
            if (listElement) {
                listElement.innerHTML = html;
            }
        } else {
            summaryCard.style.display = 'none';
        }
    }
}

// Password strength checker
function checkPasswordStrength(password) {
    let strength = 0;
    const strengthMeter = document.getElementById('passwordStrength');
    const strengthBar = document.getElementById('passwordStrengthBar');
    const strengthText = document.getElementById('passwordStrengthText');
    
    if (!strengthMeter || !strengthBar || !strengthText) return;
    
    if (password.length >= 8) strength++;
    if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
    if (password.match(/\d/)) strength++;
    if (password.match(/[^a-zA-Z\d]/)) strength++;
    
    strengthMeter.style.display = password ? 'block' : 'none';
    
    switch(strength) {
        case 0:
        case 1:
            strengthBar.style.width = '25%';
            strengthBar.className = 'progress-bar bg-danger';
            strengthText.textContent = 'Very Weak';
            break;
        case 2:
            strengthBar.style.width = '50%';
            strengthBar.className = 'progress-bar bg-warning';
            strengthText.textContent = 'Weak';
            break;
        case 3:
            strengthBar.style.width = '75%';
            strengthBar.className = 'progress-bar bg-info';
            strengthText.textContent = 'Good';
            break;
        case 4:
            strengthBar.style.width = '100%';
            strengthBar.className = 'progress-bar bg-success';
            strengthText.textContent = 'Strong';
            break;
    }
}

// Generate username from name
function generateUsername() {
    const firstName = document.getElementById('{{ form.first_name.id_for_label }}');
    const lastName = document.getElementById('{{ form.last_name.id_for_label }}');
    const usernameField = document.getElementById('{{ form.username.id_for_label }}');
    
    if (!firstName || !lastName || !usernameField) return;
    
    const firstNameVal = firstName.value.toLowerCase();
    const lastNameVal = lastName.value.toLowerCase();
    
    if (firstNameVal || lastNameVal) {
        let username = '';
        if (firstNameVal && lastNameVal) {
            username = firstNameVal.charAt(0) + lastNameVal;
        } else if (firstNameVal) {
            username = firstNameVal;
        } else {
            username = lastNameVal;
        }
        
        // Remove spaces and special characters
        username = username.replace(/[^a-z0-9]/g, '');
        
        // Add random number if username exists
        const randomNum = Math.floor(Math.random() * 1000);
        username = username + randomNum;
        
        usernameField.value = username;
        showNotification('Username generated successfully!', 'success');
    } else {
        showNotification('Please enter first name or last name first.', 'warning');
    }
}

// Generate strong password
function generatePassword() {
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
    let password = '';
    
    for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    
    const password1 = document.getElementById('id_password1');
    const password2 = document.getElementById('id_password2');
    
    if (password1 && password2) {
        password1.value = password;
        password2.value = password;
        checkPasswordStrength(password);
        showNotification('Strong password generated!', 'success');
    }
}

// Send password reset link
function sendResetLink() {
    if (confirm('Send password reset link to this user?')) {
        showNotification('Password reset link sent successfully!', 'success');
    }
}

// Show access log
function showAccessLog() {
    const modal = new bootstrap.Modal(document.getElementById('accessLogModal'));
    modal.show();
}

// Form validation
function validateForm() {
    const password1 = document.getElementById('id_password1');
    const password2 = document.getElementById('id_password2');
    const role = document.getElementById('{{ form.role.id_for_label }}');
    const isSystemAdmin = document.getElementById('{{ form.is_system_admin.id_for_label }}');
    
    if (!role || !role.value) {
        showNotification('Please select a user role.', 'warning');
        return false;
    }
    
    // Only validate passwords for new users or when passwords are provided
    const isNewUser = {% if form.instance.pk %}false{% else %}true{% endif %};
    
    if (isNewUser || (password1 && password1.value)) {
        if (!password1 || !password2) {
            showNotification('Password fields are required.', 'warning');
            return false;
        }
        
        if (password1.value !== password2.value) {
            showNotification('Passwords do not match.', 'warning');
            return false;
        }
        
        if (password1.value && password1.value.length < 8) {
            showNotification('Password must be at least 8 characters long.', 'warning');
            return false;
        }
    }
    
    // Check if at least one permission is selected for non-admin users
    const isAdminChecked = isSystemAdmin ? isSystemAdmin.checked : false;
    if (!isAdminChecked) {
        const selectedPermissions = document.querySelectorAll('.view-permission-checkbox:checked');
        if (selectedPermissions.length === 0) {
            showNotification('Please select at least one view permission for the user.', 'warning');
            return false;
        }
    }
    
    return true;
}

// Reset form
document.getElementById('resetBtn').addEventListener('click', function() {
    if (confirm('Are you sure you want to reset the form? All changes will be lost.')) {
        document.getElementById('userForm').reset();
        const permissionsSummary = document.getElementById('permissionsSummary');
        if (permissionsSummary) {
            permissionsSummary.innerHTML = '<p class="text-muted mb-0">Select a role to view permissions...</p>';
        }
        const passwordStrength = document.getElementById('passwordStrength');
        if (passwordStrength) {
            passwordStrength.style.display = 'none';
        }
        const permissionsSummaryCard = document.getElementById('permissionsSummaryCard');
        if (permissionsSummaryCard) {
            permissionsSummaryCard.style.display = 'none';
        }
        showNotification('Form reset successfully!', 'info');
    }
});

// Show notification
function showNotification(message, type = 'info') {
    // Remove existing notifications
    document.querySelectorAll('.alert-notification').forEach(alert => alert.remove());
    
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-notification alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize password strength checker
    const password1 = document.getElementById('id_password1');
    if (password1) {
        password1.addEventListener('input', function() {
            checkPasswordStrength(this.value);
        });
    }
    
    // Initialize role permissions if editing existing user
    const currentRole = document.getElementById('{{ form.role.id_for_label }}');
    if (currentRole && currentRole.value) {
        currentRole.dispatchEvent(new Event('change'));
    }
    
    // Initialize permissions summary
    updatePermissionsSummary();
    
    // Add event listeners to permission checkboxes
    document.querySelectorAll('.view-permission-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updatePermissionsSummary);
    });
    
    // Handle system admin checkbox
    const systemAdminCheckbox = document.getElementById('{{ form.is_system_admin.id_for_label }}');
    if (systemAdminCheckbox) {
        systemAdminCheckbox.addEventListener('change', function() {
            if (this.checked) {
                showNotification('System administrators automatically get access to all views.', 'info');
            }
        });
    }
    
    // Form submission handler
    const userForm = document.getElementById('userForm');
    if (userForm) {
        userForm.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% if form.instance.pk %}Updating User...{% else %}Creating User...{% endif %}';
            }
            
            return true;
        });
    }
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) submitBtn.click();
        }
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            generatePassword();
        }
        if (e.ctrlKey && e.key === 'u') {
            e.preventDefault();
            generateUsername();
        }
    });
});
</script>

<style>
.form-label {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
    padding: 0.5rem 0.75rem;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    background-color: rgba(0, 0, 0, 0.03);
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.btn {
    border-radius: 0.375rem;
    font-weight: 500;
}

.alert {
    border: none;
    border-radius: 0.375rem;
}

.progress {
    border-radius: 0.375rem;
}

/* Permission checkboxes styling */
.form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
}

.view-permission-checkbox {
    margin-right: 0.5rem;
}

/* Permission categories styling */
.col-md-6.mb-3 {
    border-right: 1px solid #e9ecef;
}

.col-md-6.mb-3:last-child {
    border-right: none;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .col-md-6.mb-3 {
        border-right: none;
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 1rem;
    }
    
    .col-md-6.mb-3:last-child {
        border-bottom: none;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        margin-bottom: 0.5rem;
        border-radius: 0.375rem !important;
    }
}

/* Custom form switch */
.form-check-input:checked {
    background-color: #198754;
    border-color: #198754;
}

/* Password strength colors */
.progress-bar {
    transition: width 0.3s ease;
}

/* Role colors */
.text-primary { color: #0d6efd !important; }
.text-success { color: #198754 !important; }
.text-info { color: #0dcaf0 !important; }
.text-warning { color: #ffc107 !important; }
.text-secondary { color: #6c757d !important; }

/* Hover effects */
.btn:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

/* Loading states */
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Form text styling */
.form-text {
    font-size: 0.875rem;
}

/* Card hover effects */
.card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    transition: box-shadow 0.2s ease;
}

/* Notification styling */
.alert-notification {
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Permission summary card */
#permissionsSummaryCard {
    background-color: #f8f9fa;
    border-left: 4px solid #0d6efd;
}

/* Badge styling */
.badge {
    font-size: 0.75em;
}

/* Error styling */
.is-invalid {
    border-color: #dc3545 !important;
}

.invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}

/* Success styling */
.is-valid {
    border-color: #198754 !important;
}

/* Messages container */
.messages-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1060;
    min-width: 350px;
}

/* Form validation states */
.was-validated .form-control:valid {
    border-color: #198754;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.was-validated .form-control:invalid {
    border-color: #dc3545;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6.4.4.4-.4'/%3e%3cpath d='M6 7v2'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}
</style>
{% endblock %}