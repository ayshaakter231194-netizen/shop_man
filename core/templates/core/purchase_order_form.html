{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block title %}
    {% if form.instance.pk %}Edit Purchase Order{% else %}Create Purchase Order{% endif %} - Shop Management
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-shopping-cart"></i>
        {% if form.instance.pk %}Edit Purchase Order{% else %}Create Purchase Order{% endif %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'purchase_report' %}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Purchases
        </a>
    </div>
</div>

<div class="row">
    <!-- Purchase Order Form -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> Purchase Order Details
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="purchaseOrderForm" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="row">
                        <!-- Supplier Selection -->
                        <div class="col-md-6 mb-3">
                            <label for="supplierSearch" class="form-label">
                                Supplier <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="supplierSearch" 
                                   placeholder="Type supplier name..." 
                                   value="{{ form.supplier.value|default:'' }}"
                                   autocomplete="off" required>
                            <input type="hidden" name="supplier" id="selectedSupplierId" value="{{ form.supplier.value|default:'' }}">
                            {% if form.supplier.errors %}
                                <div class="text-danger small">{{ form.supplier.errors }}</div>
                            {% endif %}
                            <div class="form-text">
                                Type supplier name and select from available options
                            </div>
                        </div>

                        <!-- Expected Delivery Date -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.expected_date.id_for_label }}" class="form-label">
                                Expected Delivery Date <span class="text-danger">*</span>
                            </label>
                            {{ form.expected_date }}
                            {% if form.expected_date.errors %}
                                <div class="text-danger small">{{ form.expected_date.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Product Search Field -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">
                                <i class="fas fa-list-ol"></i> Order Items
                            </h6>
                            <span class="badge bg-primary" id="itemsCount">0 items</span>
                        </div>

                        <!-- Product Search -->
                        <div class="mb-3">
                            <label for="productQuickSearch" class="form-label">Add Product to Order</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="productQuickSearch" 
                                       placeholder="Select a supplier first to search products..." 
                                       autocomplete="off" disabled>
                                <div class="search-dropdown" id="productQuickDropdown" style="display: none;">
                                    <div class="search-results" id="productQuickResults">
                                        <!-- Product results will appear here -->
                                    </div>
                                </div>
                            </div>
                            <div class="form-text">Type to search products. Use ↑↓ arrows to navigate, Enter to select</div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-sm" id="orderItemsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th width="35%">Product</th>
                                        <th width="15%">Quantity</th>
                                        <th width="15%">Unit Cost</th>
                                        <th width="20%">Total Cost</th>
                                        <th width="15%">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="orderItemsBody">
                                    <!-- Items will be added dynamically -->
                                    <tr id="noItemsRow">
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-cube fa-2x mb-2"></i><br>
                                            No items added to this order
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="table-active">
                                        <td colspan="3" class="text-end"><strong>Grand Total:</strong></td>
                                        <td colspan="2">
                                            <strong id="grandTotal">৳0.00</strong>
                                            <input type="hidden" name="total_amount" id="totalAmount" value="0">
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- Additional Notes -->
                    <div class="mb-3">
                        <label for="notes" class="form-label">Additional Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="Any special instructions or notes for this purchase order...">{{ form.notes.value|default:'' }}</textarea>
                    </div>

                    <!-- Form Actions -->
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-success w-100" id="submitBtn">
                                <i class="fas fa-save"></i>
                                {% if form.instance.pk %}Update Order{% else %}Create Order{% endif %}
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" name="draft" value="true" class="btn btn-warning w-100" id="saveDraftBtn">
                                <i class="fas fa-file-alt"></i> Save as Draft
                            </button>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'purchase_report' %}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Order Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-pie"></i> Order Summary
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block">Total Items</small>
                            <strong id="summaryTotalItems" class="text-primary">0</strong>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="border rounded p-2">
                            <small class="text-muted d-block">Total Quantity</small>
                            <strong id="summaryTotalQty" class="text-info">0</strong>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="bg-light rounded p-3">
                            <small class="text-muted d-block">Order Total</small>
                            <strong id="summaryGrandTotal" class="text-success fs-5">৳0.00</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Products -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-bolt"></i> Quick Add Products
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-2" id="quickProducts">
                    {% for product in quick_products %}
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-secondary w-100 text-start quick-product-btn" 
                                data-product-id="{{ product.id }}"
                                data-product-name="{{ product.name }}"
                                data-product-sku="{{ product.sku }}"
                                data-product-price="{{ product.cost_price }}"
                                data-supplier-id="{{ product.supplier.id|default:'' }}"
                                disabled>
                            <small>
                                <strong>{{ product.name }}</strong><br>
                                <span class="text-muted">৳{{ product.cost_price|floatformat:2 }} • Stock: {{ product.current_stock }}</span>
                                {% if product.supplier %}
                                <br><small class="text-info">Supplier: {{ product.supplier.name }}</small>
                                {% endif %}
                            </small>
                        </button>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center text-muted">
                        <small>No low stock products found</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Help Card -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-question-circle"></i> Purchase Order Guide
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6 class="alert-heading">
                        <i class="fas fa-lightbulb"></i> Best Practices
                    </h6>
                    <ul class="mb-0 small ps-3">
                        <li>Select supplier first, then add products</li>
                        <li>Set realistic expected delivery dates</li>
                        <li>Double-check quantities and unit costs</li>
                        <li>Use quick add buttons or search by name</li>
                    </ul>
                </div>
                
                <div class="alert alert-warning">
                    <h6 class="alert-heading">
                        <i class="fas fa-exclamation-triangle"></i> Important
                    </h6>
                    <p class="mb-0 small">
                        Purchase orders cannot be edited after they are marked as "Completed". 
                        Please review all details before submitting.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Order items management
let orderItems = [];
let currentSupplierId = null;
let selectedProductIndex = -1;

// Initialize products data
let allProducts = {
    {% for product in products %}
    {{ product.id }}: {
        id: {{ product.id }},
        name: "{{ product.name|escapejs }}",
        sku: "{{ product.sku|escapejs }}",
        cost_price: {{ product.cost_price }},
        supplier_id: {{ product.supplier.id|default:'null' }},
        search_text: "{{ product.name|lower|escapejs }} {{ product.sku|lower|escapejs }}"
    },
    {% endfor %}
};

// Initialize suppliers data
const suppliers = {
    {% for supplier in suppliers %}
    {{ supplier.id }}: {
        id: {{ supplier.id }},
        name: "{{ supplier.name|escapejs }}",
        search_text: "{{ supplier.name|lower|escapejs }}"
    },
    {% endfor %}
};

// DOM Elements - Wait for page to load
let orderItemsBody, noItemsRow, itemsCountElement;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize DOM elements after page loads
    orderItemsBody = document.getElementById('orderItemsBody');
    noItemsRow = document.getElementById('noItemsRow');
    itemsCountElement = document.getElementById('itemsCount');
    
    console.log('DOM Elements initialized:', {
        orderItemsBody: !!orderItemsBody,
        noItemsRow: !!noItemsRow,
        itemsCountElement: !!itemsCountElement
    });
    
    updateOrderSummary();
    
    // Set minimum date for expected delivery to today
    const today = new Date().toISOString().split('T')[0];
    const expectedDateField = document.getElementById('{{ form.expected_date.id_for_label }}');
    if (expectedDateField) {
        expectedDateField.min = today;
        // Set default to 7 days from today if not already set
        if (!expectedDateField.value) {
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            expectedDateField.value = nextWeek.toISOString().split('T')[0];
        }
    }
    
    // Initialize with existing supplier value if any
    const initialSupplierId = document.getElementById('selectedSupplierId').value;
    if (initialSupplierId && suppliers[initialSupplierId]) {
        currentSupplierId = initialSupplierId;
        document.getElementById('supplierSearch').value = suppliers[initialSupplierId].name;
        updateProductSearch();
    }
    
    console.log('Purchase order form initialized');
    console.log('Available products:', Object.keys(allProducts).length);
    console.log('Available suppliers:', Object.keys(suppliers).length);
});

// Get products filtered by supplier
function getProductsBySupplier(supplierId) {
    if (!supplierId) return {};
    
    const filteredProducts = {};
    Object.keys(allProducts).forEach(productId => {
        const product = allProducts[productId];
        if (product.supplier_id == supplierId) {
            filteredProducts[productId] = product;
        }
    });
    return filteredProducts;
}

// Update product search based on selected supplier
function updateProductSearch() {
    const productQuickSearch = document.getElementById('productQuickSearch');
    if (currentSupplierId) {
        productQuickSearch.placeholder = `Search ${suppliers[currentSupplierId].name}'s products...`;
        productQuickSearch.disabled = false;
        productQuickSearch.style.backgroundColor = '';
        
        // Enable quick product buttons for this supplier
        document.querySelectorAll('.quick-product-btn').forEach(btn => {
            const productSupplierId = btn.dataset.supplierId;
            if (!productSupplierId || productSupplierId == currentSupplierId) {
                btn.disabled = false;
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-outline-primary');
            } else {
                btn.disabled = true;
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-outline-secondary');
            }
        });
    } else {
        productQuickSearch.placeholder = "Select a supplier first to search products...";
        productQuickSearch.disabled = true;
        productQuickSearch.style.backgroundColor = '#f8f9fa';
        
        // Disable all quick product buttons
        document.querySelectorAll('.quick-product-btn').forEach(btn => {
            btn.disabled = true;
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-outline-secondary');
        });
    }
}

// Search products - filtered by selected supplier
function searchProducts(searchTerm) {
    const productQuickResults = document.getElementById('productQuickResults');
    productQuickResults.innerHTML = '';
    selectedProductIndex = -1;
    
    // Check if supplier is selected
    if (!currentSupplierId) {
        showNotification('Please select a supplier first', 'warning');
        return;
    }
    
    if (searchTerm.length < 2) {
        document.getElementById('productQuickDropdown').style.display = 'none';
        return;
    }
    
    const filteredProducts = getProductsBySupplier(currentSupplierId);
    const searchResults = Object.values(filteredProducts).filter(product => 
        product.search_text.includes(searchTerm.toLowerCase())
    ).slice(0, 8);
    
    if (searchResults.length > 0) {
        searchResults.forEach((product, index) => {
            const resultItem = document.createElement('div');
            resultItem.className = 'search-result-item';
            resultItem.innerHTML = `
                <div class="search-result-content">
                    <strong>${product.name}</strong>
                    <small class="text-muted d-block">
                        SKU: ${product.sku} | 
                        ৳${product.cost_price.toFixed(2)}
                    </small>
                </div>
            `;
            resultItem.dataset.productId = product.id;
            resultItem.dataset.index = index;
            
            resultItem.addEventListener('click', function() {
                addProductToOrder(product.id);
            });
            
            resultItem.addEventListener('mouseenter', function() {
                setSelectedProductIndex(index);
            });
            
            productQuickResults.appendChild(resultItem);
        });
        
        document.getElementById('productQuickDropdown').style.display = 'block';
        setSelectedProductIndex(0);
    } else {
        document.getElementById('productQuickDropdown').style.display = 'none';
        if (searchTerm.length >= 2) {
            // Show no results message
            const noResults = document.createElement('div');
            noResults.className = 'search-result-item text-muted';
            noResults.innerHTML = 'No products found for this supplier';
            productQuickResults.appendChild(noResults);
            document.getElementById('productQuickDropdown').style.display = 'block';
        }
    }
}

// Set selected product index
function setSelectedProductIndex(index) {
    const items = document.getElementById('productQuickResults').querySelectorAll('.search-result-item');
    items.forEach(item => item.classList.remove('selected'));
    
    if (items[index]) {
        items[index].classList.add('selected');
        selectedProductIndex = index;
    }
}

// Get current selected product
function getSelectedProduct() {
    const items = document.getElementById('productQuickResults').querySelectorAll('.search-result-item');
    if (selectedProductIndex >= 0 && items[selectedProductIndex]) {
        const productId = items[selectedProductIndex].dataset.productId;
        return allProducts[productId];
    }
    return null;
}

// Add product to order - FIXED VERSION
function addProductToOrder(productId) {
    const product = allProducts[productId];
    
    if (!product) {
        console.error('Product not found:', productId);
        showNotification('Product not found', 'error');
        return;
    }

    console.log('Adding product:', product);

    // Check if product already in order
    const existingItemIndex = orderItems.findIndex(item => item.productId == productId);
    
    if (existingItemIndex !== -1) {
        // Update existing item quantity
        orderItems[existingItemIndex].quantity += 1;
        updateItemTotalCost(existingItemIndex);
        showNotification(`${product.name} quantity increased to ${orderItems[existingItemIndex].quantity}`, 'info');
        console.log('Updated existing item:', orderItems[existingItemIndex]);
    } else {
        // Add new item
        const item = {
            productId: productId,
            productName: product.name,
            productSku: product.sku,
            quantity: 1,
            unitCost: parseFloat(product.cost_price),
            totalCost: parseFloat(product.cost_price)
        };
        orderItems.push(item);
        showNotification(`${product.name} added to order`, 'success');
        console.log('Added new item:', item);
    }
    
    updateOrderItemsDisplay();
    updateOrderSummary();
    
    // Clear search and hide dropdown
    document.getElementById('productQuickSearch').value = '';
    document.getElementById('productQuickDropdown').style.display = 'none';
    
    // Focus back on search for quick additions
    setTimeout(() => {
        document.getElementById('productQuickSearch').focus();
    }, 100);
}

// Update item total cost when quantity or unit cost changes
function updateItemTotalCost(itemIndex) {
    const item = orderItems[itemIndex];
    if (item) {
        item.totalCost = item.quantity * item.unitCost;
        console.log(`Updated item ${itemIndex} total cost: ${item.totalCost}`);
    }
}

// Update order items display with editable fields - FIXED VERSION
function updateOrderItemsDisplay() {
    console.log('Updating display with items:', orderItems);
    console.log('Order items body element:', orderItemsBody);

    if (!orderItemsBody) {
        console.error('Order items body element not found!');
        return;
    }

    if (orderItems.length === 0) {
        // Show "no items" message
        orderItemsBody.innerHTML = `
            <tr id="noItemsRow">
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="fas fa-cube fa-2x mb-2"></i><br>
                    No items added to this order
                </td>
            </tr>
        `;
        return;
    }
    
    // Build the items table
    let html = '';
    orderItems.forEach((item, index) => {
        html += `
            <tr data-item-index="${index}" class="order-item-row">
                <td>
                    <strong>${item.productName}</strong><br>
                    <small class="text-muted">SKU: ${item.productSku}</small>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm item-quantity" 
                           value="${item.quantity}" min="1" 
                           data-item-index="${index}"
                           onchange="updateItemQuantity(${index}, this.value)"
                           onblur="validateQuantity(${index}, this)">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm item-unit-cost" 
                           value="${item.unitCost.toFixed(2)}" step="0.01" min="0"
                           data-item-index="${index}"
                           onchange="updateItemUnitCost(${index}, this.value)"
                           onblur="validateUnitCost(${index}, this)">
                </td>
                <td class="text-end">
                    <strong class="item-total-cost">৳${item.totalCost.toFixed(2)}</strong>
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(${index})" title="Remove item">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    orderItemsBody.innerHTML = html;
    console.log('Display updated with', orderItems.length, 'items');
    
    // Update the items count badge
    if (itemsCountElement) {
        itemsCountElement.textContent = `${orderItems.length} ${orderItems.length === 1 ? 'item' : 'items'}`;
    }
}

function validateQuantity(itemIndex, input) {
    const quantity = parseInt(input.value) || 1;
    if (quantity < 1) {
        input.value = 1;
        updateItemQuantity(itemIndex, 1);
    }
}

function validateUnitCost(itemIndex, input) {
    const unitCost = parseFloat(input.value) || 0;
    if (unitCost < 0) {
        input.value = '0.00';
        updateItemUnitCost(itemIndex, 0);
    }
}

// Update item quantity - FIXED VERSION
function updateItemQuantity(itemIndex, newQuantity) {
    const quantity = parseInt(newQuantity) || 1;
    const item = orderItems[itemIndex];
    
    if (item) {
        console.log(`Updating item ${itemIndex} quantity from ${item.quantity} to ${quantity}`);
        item.quantity = quantity;
        updateItemTotalCost(itemIndex);
        updateOrderItemsDisplay();
        updateOrderSummary();
    }
}

// Update item unit cost - FIXED VERSION
function updateItemUnitCost(itemIndex, newUnitCost) {
    const unitCost = parseFloat(newUnitCost) || 0;
    const item = orderItems[itemIndex];
    
    if (item) {
        console.log(`Updating item ${itemIndex} unit cost from ${item.unitCost} to ${unitCost}`);
        item.unitCost = unitCost;
        updateItemTotalCost(itemIndex);
        updateOrderItemsDisplay();
        updateOrderSummary();
    }
}

// Remove item from order - FIXED VERSION
function removeItem(itemIndex) {
    if (confirm('Are you sure you want to remove this item from the order?')) {
        const removedItem = orderItems.splice(itemIndex, 1)[0];
        console.log('Removed item:', removedItem);
        updateOrderItemsDisplay();
        updateOrderSummary();
        showNotification(`${removedItem.productName} removed from order`, 'warning');
    }
}

// Update order summary - FIXED VERSION
function updateOrderSummary() {
    const totalItems = orderItems.length;
    const totalQuantity = orderItems.reduce((sum, item) => sum + item.quantity, 0);
    const grandTotal = orderItems.reduce((sum, item) => sum + item.totalCost, 0);
    
    console.log(`Summary - Items: ${totalItems}, Quantity: ${totalQuantity}, Total: ${grandTotal}`);
    
    // Update summary elements
    const summaryTotalItems = document.getElementById('summaryTotalItems');
    const summaryTotalQty = document.getElementById('summaryTotalQty');
    const summaryGrandTotal = document.getElementById('summaryGrandTotal');
    const grandTotalElement = document.getElementById('grandTotal');
    const totalAmountInput = document.getElementById('totalAmount');
    
    if (summaryTotalItems) summaryTotalItems.textContent = totalItems;
    if (summaryTotalQty) summaryTotalQty.textContent = totalQuantity;
    if (summaryGrandTotal) summaryGrandTotal.textContent = '৳' + grandTotal.toFixed(2);
    if (grandTotalElement) grandTotalElement.textContent = '৳' + grandTotal.toFixed(2);
    if (totalAmountInput) totalAmountInput.value = grandTotal.toFixed(2);
    
    // Update items count badge
    if (itemsCountElement) {
        itemsCountElement.textContent = `${totalItems} ${totalItems === 1 ? 'item' : 'items'}`;
    }
}

// Supplier selection
document.getElementById('supplierSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const supplierSearch = document.getElementById('supplierSearch');
    const selectedSupplierId = document.getElementById('selectedSupplierId');
    
    currentSupplierId = null;
    selectedSupplierId.value = '';
    
    // Reset product search
    document.getElementById('productQuickSearch').disabled = true;
    document.getElementById('productQuickSearch').placeholder = "Select a supplier first to search products...";
    document.getElementById('productQuickSearch').value = '';
    document.getElementById('productQuickDropdown').style.display = 'none';
    
    // Disable all quick product buttons
    document.querySelectorAll('.quick-product-btn').forEach(btn => {
        btn.disabled = true;
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-outline-secondary');
    });
    
    if (searchTerm.length < 2) {
        return;
    }
    
    // Find matching supplier
    let foundSupplier = null;
    for (const supplierId in suppliers) {
        if (suppliers[supplierId].name.toLowerCase().includes(searchTerm)) {
            foundSupplier = suppliers[supplierId];
            break;
        }
    }
    
    if (foundSupplier) {
        currentSupplierId = foundSupplier.id;
        selectedSupplierId.value = foundSupplier.id;
        supplierSearch.value = foundSupplier.name;
        
        // Enable product search
        updateProductSearch();
        
        showNotification(`Supplier set to ${foundSupplier.name}`, 'success');
        
        // Focus on product search
        setTimeout(() => {
            document.getElementById('productQuickSearch').focus();
        }, 100);
    }
});

// Product search functionality
document.getElementById('productQuickSearch').addEventListener('input', function(e) {
    // Check if supplier is selected before searching
    if (!currentSupplierId) {
        showNotification('Please select a supplier first', 'warning');
        this.value = '';
        return;
    }
    searchProducts(this.value);
});

document.getElementById('productQuickSearch').addEventListener('keydown', function(e) {
    // Check if supplier is selected
    if (!currentSupplierId) {
        if (e.key === 'Enter') {
            e.preventDefault();
            showNotification('Please select a supplier first', 'warning');
            document.getElementById('supplierSearch').focus();
        }
        return;
    }

    const items = document.getElementById('productQuickResults').querySelectorAll('.search-result-item');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (selectedProductIndex < items.length - 1) {
            setSelectedProductIndex(selectedProductIndex + 1);
        }
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (selectedProductIndex > 0) {
            setSelectedProductIndex(selectedProductIndex - 1);
        }
    } else if (e.key === 'Enter') {
        e.preventDefault();
        const selectedProduct = getSelectedProduct();
        if (selectedProduct) {
            addProductToOrder(selectedProduct.id);
        } else if (this.value.trim()) {
            // Try to find exact match by name
            const filteredProducts = getProductsBySupplier(currentSupplierId);
            const exactMatch = Object.values(filteredProducts).find(p => 
                p.name.toLowerCase() === this.value.toLowerCase()
            );
            if (exactMatch) {
                addProductToOrder(exactMatch.id);
            } else {
                showNotification('No product found with that name', 'warning');
            }
        }
    } else if (e.key === 'Escape') {
        document.getElementById('productQuickDropdown').style.display = 'none';
    }
});

// Hide dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!document.getElementById('productQuickSearch').contains(e.target) && 
        !document.getElementById('productQuickDropdown').contains(e.target)) {
        document.getElementById('productQuickDropdown').style.display = 'none';
    }
});

// Quick product buttons
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.quick-product-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (!currentSupplierId) {
                showNotification('Please select a supplier first', 'warning');
                return;
            }

            const productId = this.dataset.productId;
            const productSupplierId = this.dataset.supplierId;
            
            // Check if product belongs to selected supplier
            if (productSupplierId && productSupplierId != currentSupplierId) {
                showNotification(`This product belongs to a different supplier`, 'warning');
                return;
            }
            
            addProductToOrder(productId);
        });
    });
});

// Form submission - Create hidden fields for all items - FIXED VERSION
document.getElementById('purchaseOrderForm').addEventListener('submit', function(e) {
    const supplierId = document.getElementById('selectedSupplierId').value;
    
    if (!supplierId) {
        e.preventDefault();
        showNotification('Please select a supplier.', 'error');
        document.getElementById('supplierSearch').focus();
        return;
    }
    
    if (orderItems.length === 0) {
        e.preventDefault();
        showNotification('Please add at least one item to the purchase order.', 'error');
        return;
    }
    
    console.log('Submitting order with items:', orderItems);
    
    // Clear any existing hidden fields first
    const existingHiddenFields = this.querySelectorAll('input[type="hidden"][name^="order_items"]');
    existingHiddenFields.forEach(field => field.remove());
    
    // Add order items to form data with proper naming convention
    orderItems.forEach((item, index) => {
        console.log(`Processing item ${index}:`, item);
        
        // Create hidden fields for each item
        const fields = [
            { name: `order_items[${index}][product]`, value: item.productId },
            { name: `order_items[${index}][quantity]`, value: item.quantity },
            { name: `order_items[${index}][unit_cost]`, value: item.unitCost.toFixed(2) },
            { name: `order_items[${index}][total_cost]`, value: item.totalCost.toFixed(2) }
        ];
        
        fields.forEach(field => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = field.name;
            input.value = field.value;
            this.appendChild(input);
            console.log(`Added field: ${field.name} = ${field.value}`);
        });
    });
    
    console.log('Form prepared for submission with', orderItems.length, 'items');
    
    // Optional: Show confirmation before submitting
    if (orderItems.length > 1) {
        const confirmed = confirm(`Are you sure you want to submit this purchase order with ${orderItems.length} items?`);
        if (!confirmed) {
            e.preventDefault();
            return;
        }
    }
});

// Simple notification function
function showNotification(message, type = 'info') {
    // Remove any existing notifications
    const existingAlerts = document.querySelectorAll('.custom-alert');
    existingAlerts.forEach(alert => alert.remove());
    
    const alert = document.createElement('div');
    alert.className = `custom-alert alert alert-${type} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    alert.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="flex-grow-1">${message}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 4000);
}

// Test function to add multiple items quickly - SAFE VERSION
function testAddMultipleItems() {
    console.log('Testing multiple items addition...');
    
    // Check if supplier is selected
    if (!currentSupplierId) {
        showNotification('Please select a supplier first', 'warning');
        return;
    }
    
    // Get products for the current supplier
    const filteredProducts = getProductsBySupplier(currentSupplierId);
    const productIds = Object.keys(filteredProducts).slice(0, 3);
    
    if (productIds.length === 0) {
        showNotification('No products available for this supplier', 'warning');
        return;
    }
    
    console.log(`Adding ${productIds.length} test products...`);
    
    productIds.forEach((productId, index) => {
        setTimeout(() => {
            addProductToOrder(productId);
            console.log(`Added product ${index + 1}: ${allProducts[productId].name}`);
        }, index * 500);
    });
}

// Debug function to check form data before submission
function debugFormData() {
    console.log('=== DEBUG FORM DATA ===');
    console.log('Order Items:', orderItems);
    
    const form = document.getElementById('purchaseOrderForm');
    const formData = new FormData(form);
    
    console.log('=== FORM DATA ENTRIES ===');
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
    }
    
    console.log('=== ORDER ITEMS COUNT ===');
    let itemCount = 0;
    for (let key of formData.keys()) {
        if (key.startsWith('order_items[') && key.includes('][product]')) {
            itemCount++;
        }
    }
    console.log(`Found ${itemCount} order items in form data`);
}
</script>

<style>
.form-label {
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
    padding: 0.5rem 0.75rem;
}

.form-control:focus, .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    background-color: rgba(0, 0, 0, 0.03);
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.btn {
    border-radius: 0.375rem;
    font-weight: 500;
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
}

.quick-product-btn {
    text-align: left;
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
}

.quick-product-btn:hover:not(:disabled) {
    border-color: #0d6efd;
    background-color: #f8f9fa;
    transform: translateY(-1px);
}

.quick-product-btn:disabled {
    cursor: not-allowed;
    opacity: 0.6;
}

.alert {
    border: none;
    border-radius: 0.375rem;
}

#noItemsRow {
    display: table-row;
}

/* Enhanced search dropdown styling */
.search-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    z-index: 1060;
    max-height: 300px;
    overflow-y: auto;
}

.search-result-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f8f9fa;
    cursor: pointer;
    transition: background-color 0.15s ease;
}

.search-result-item:hover {
    background-color: #f8f9fa;
}

.search-result-item.selected {
    background-color: #e7f1ff;
    border-left: 3px solid #0d6efd;
}

.search-result-content strong {
    display: block;
    margin-bottom: 0.25rem;
}

.search-result-content small {
    font-size: 0.8rem;
}

.order-item-row:hover {
    background-color: #f8f9fa;
}

.order-item-row td {
    vertical-align: middle;
}

/* Custom alert styling */
.custom-alert {
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .search-dropdown {
        position: fixed;
        left: 10px;
        right: 10px;
        max-width: calc(100vw - 20px);
    }
    
    .custom-alert {
        left: 10px;
        right: 10px;
        max-width: calc(100vw - 20px);
    }
}

/* Focus styles for better accessibility */
.form-control:focus,
.btn:focus {
    outline: 2px solid #0d6efd;
    outline-offset: 2px;
}

/* Animation for smooth interactions */
.quick-product-btn,
.search-result-item,
.order-item-row {
    transition: all 0.2s ease-in-out;
}

/* Style for disabled fields */
.form-control:disabled {
    background-color: #f8f9fa;
    cursor: not-allowed;
}

/* Badge styling */
#itemsCount {
    font-size: 0.8rem;
}

/* Table input styling */
.item-quantity, .item-unit-cost {
    max-width: 100px;
}
</style>
{% endblock %}