{% extends 'base.html' %}
{% load custom_filters %} 

{% block title %}Process Sale Return - {{ sale_return.return_number }}{% endblock %}

{% block page_title %}
<i class="fas fa-cog"></i> Process Sale Return - {{ sale_return.return_number }}
{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'sale_return_list' %}">Sale Returns</a></li>
<li class="breadcrumb-item"><a href="{% url 'sale_return_detail' sale_return.id %}">{{ sale_return.return_number }}</a></li>
<li class="breadcrumb-item active">Process</li>
{% endblock %}

{% block inner_content %}
<div class="row">
    <div class="col-md-8">
        <!-- Return Summary Card -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> Return Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <th width="40%">Return Number:</th>
                                <td><strong>{{ sale_return.return_number }}</strong></td>
                            </tr>
                            <tr>
                                <th>Original Invoice:</th>
                                <td>{{ sale_return.sale.invoice_number }}</td>
                            </tr>
                            <tr>
                                <th>Customer:</th>
                                <td>{{ sale_return.sale.customer_name|default:"Walk-in Customer" }}</td>
                            </tr>
                            <tr>
                                <th>Return Type:</th>
                                <td>
                                    <span class="badge bg-{% if sale_return.return_type == 'money' %}info{% else %}warning{% endif %}">
                                        {{ sale_return.get_return_type_display }}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <th width="40%">Current Status:</th>
                                <td>
                                    <span class="badge bg-{% if sale_return.status == 'pending' %}warning
                                                          {% elif sale_return.status == 'approved' %}info
                                                          {% elif sale_return.status == 'completed' %}success
                                                          {% else %}danger{% endif %}">
                                        {{ sale_return.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th>Refund Amount:</th>
                                <td class="fw-bold text-danger">৳{{ sale_return.refund_amount }}</td>
                            </tr>
                            {% if sale_return.return_type == 'product' and sale_return.balance_amount != 0 %}
                            <tr>
                                <th>Balance Amount:</th>
                                <td class="fw-bold {% if sale_return.balance_amount > 0 %}text-success{% else %}text-warning{% endif %}">
                                    ৳{{ sale_return.balance_amount|abs }}
                                    <small class="ms-1">
                                        {% if sale_return.balance_amount > 0 %}
                                        (Refund to customer)
                                        {% else %}
                                        (Customer to pay)
                                        {% endif %}
                                    </small>
                                </td>
                            </tr>
                            {% endif %}
                            <tr>
                                <th>Return Date:</th>
                                <td>{{ sale_return.return_date|date:"M d, Y H:i" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Returned Items Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-boxes"></i> Returned Items
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Return Qty</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in sale_return.items.all %}
                            <tr>
                                <td>
                                    <strong>{{ item.sale_item.product.name }}</strong>
                                    <br>
                                    <small class="text-muted">SKU: {{ item.sale_item.product.sku }}</small>
                                    {% if item.batch %}
                                    <br>
                                    <small class="text-muted">Batch: {{ item.batch.batch_number }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ item.quantity }}</span>
                                </td>
                                <td>৳{{ item.unit_price }}</td>
                                <td class="fw-bold">৳{{ item.total_price }}</td>
                                <td>
                                    <span class="badge bg-light text-dark">{{ item.get_reason_display }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-primary">
                                <td colspan="3" class="text-end fw-bold">Total Refund Value:</td>
                                <td class="fw-bold">৳{{ sale_return.refund_amount }}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Processing Form Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs"></i> Process Return
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="processForm">
                    {% csrf_token %}
                    
                    <!-- Action Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Select Action:</label>
                        <div class="row">
                            {% if sale_return.status == 'pending' %}
                            <div class="col-md-4 mb-3">
                                <div class="form-check card border {% if sale_return.status == 'pending' %}border-primary{% endif %} h-100">
                                    <input class="form-check-input" type="radio" name="action" value="approve" id="actionApprove" 
                                           {% if sale_return.status == 'pending' %}checked{% endif %}>
                                    <label class="form-check-label card-body" for="actionApprove">
                                        <h6 class="card-title text-success">
                                            <i class="fas fa-check-circle"></i> Approve Return
                                        </h6>
                                        <p class="card-text small text-muted">
                                            Approve this return for processing. Items will be ready for refund/exchange.
                                        </p>
                                    </label>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if sale_return.status == 'approved' %}
                            <div class="col-md-4 mb-3">
                                <div class="form-check card border {% if sale_return.status == 'approved' %}border-primary{% endif %} h-100">
                                    <input class="form-check-input" type="radio" name="action" value="complete" id="actionComplete" 
                                           {% if sale_return.status == 'approved' %}checked{% endif %}>
                                    <label class="form-check-label card-body" for="actionComplete">
                                        <h6 class="card-title text-info">
                                            <i class="fas fa-check-double"></i> Complete Return
                                        </h6>
                                        <p class="card-text small text-muted">
                                            Finalize the return process. Stock will be updated and refund/exchange processed.
                                        </p>
                                    </label>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="col-md-4 mb-3">
                                <div class="form-check card border border-danger h-100">
                                    <input class="form-check-input" type="radio" name="action" value="reject" id="actionReject">
                                    <label class="form-check-label card-body" for="actionReject">
                                        <h6 class="card-title text-danger">
                                            <i class="fas fa-times-circle"></i> Reject Return
                                        </h6>
                                        <p class="card-text small text-muted">
                                            Reject this return request. Provide reason in notes below.
                                        </p>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Exchange Product Details (for product returns) -->
                    {% if sale_return.return_type == 'product' %}
                    <div class="mb-4 p-3 border rounded bg-light" id="exchangeSection">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-exchange-alt"></i> Exchange Product Details
                        </h6>
                        
                        {% if sale_return.exchange_product %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Exchange Product:</label>
                                    <p class="form-control-plaintext">
                                        {{ sale_return.exchange_product.name }}
                                        <br>
                                        <small class="text-muted">
                                            SKU: {{ sale_return.exchange_product.sku }}
                                            <br>
                                            Price: ৳{{ sale_return.exchange_product.selling_price }}
                                        </small>
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Exchange Quantity:</label>
                                    <p class="form-control-plaintext">
                                        {{ sale_return.exchange_quantity }} units
                                        <br>
                                        <small class="text-muted">
                                            Total: ৳{{ sale_return.exchange_product_value }}
                                        </small>
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Balance Amount Display -->
                        {% if sale_return.balance_amount != 0 %}
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="card {% if sale_return.balance_amount > 0 %}border-success{% else %}border-warning{% endif %}">
                                    <div class="card-header {% if sale_return.balance_amount > 0 %}bg-success text-white{% else %}bg-warning text-dark{% endif %}">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-money-bill-wave"></i> Balance Amount
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-md-4">
                                                <strong>Return Value:</strong>
                                                <div class="text-danger">৳{{ sale_return.refund_amount }}</div>
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Exchange Value:</strong>
                                                <div class="text-info">৳{{ sale_return.exchange_product_value }}</div>
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Balance:</strong>
                                                <div class="fw-bold {% if sale_return.balance_amount > 0 %}text-success{% else %}text-warning{% endif %}">
                                                    ৳{{ sale_return.balance_amount|abs }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-center mt-2">
                                            {% if sale_return.balance_amount > 0 %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-arrow-up"></i>
                                                Customer to receive refund
                                            </span>
                                            {% else %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-arrow-down"></i>
                                                Customer to pay extra
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-equals"></i>
                            <strong>Equal Exchange:</strong> No balance amount - values match exactly.
                        </div>
                        {% endif %}
                        
                        <!-- Stock Check -->
                        <div class="alert {% if sale_return.can_process_exchange %}alert-success{% else %}alert-warning{% endif %} mt-3">
                            <i class="fas {% if sale_return.can_process_exchange %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %}"></i>
                            {% if sale_return.can_process_exchange %}
                            Sufficient stock available for exchange.
                            {% else %}
                            <strong>Warning:</strong> Insufficient stock for exchange. 
                            Available: {{ sale_return.exchange_product.current_stock }}, Required: {{ sale_return.exchange_quantity }}
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            No exchange product selected for this return.
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Stock Impact Preview -->
                    <div class="mb-4 p-3 border rounded bg-light" id="stockImpactSection">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-boxes"></i> Stock Impact Preview
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-success">
                                    <i class="fas fa-arrow-up"></i> Stock to be Added Back:
                                </h6>
                                <ul class="list-group">
                                    {% for item in sale_return.items.all %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ item.sale_item.product.name }}
                                        <span class="badge bg-success rounded-pill">+{{ item.quantity }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            
                            {% if sale_return.return_type == 'product' and sale_return.exchange_product %}
                            <div class="col-md-6">
                                <h6 class="text-danger">
                                    <i class="fas fa-arrow-down"></i> Stock to be Reduced:
                                </h6>
                                <ul class="list-group">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ sale_return.exchange_product.name }}
                                        <span class="badge bg-danger rounded-pill">-{{ sale_return.exchange_quantity }}</span>
                                    </li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Financial Impact -->
                        {% if sale_return.return_type == 'product' and sale_return.balance_amount != 0 %}
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <h6 class="fw-bold">
                                    <i class="fas fa-money-bill-wave"></i> Financial Impact:
                                </h6>
                                <div class="alert {% if sale_return.balance_amount > 0 %}alert-success{% else %}alert-warning{% endif %}">
                                    {% if sale_return.balance_amount > 0 %}
                                    <i class="fas fa-arrow-up text-success"></i>
                                    <strong>Refund to Customer:</strong> ৳{{ sale_return.balance_amount|abs }} will be refunded to the customer.
                                    {% else %}
                                    <i class="fas fa-arrow-down text-warning"></i>
                                    <strong>Payment from Customer:</strong> Customer needs to pay ৳{{ sale_return.balance_amount|abs }} extra.
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Processing Notes -->
                    <div class="mb-4">
                        <label for="notes" class="form-label fw-bold">
                            <i class="fas fa-sticky-note"></i> Processing Notes
                        </label>
                        <textarea class="form-control" id="notes" name="notes" rows="4" 
                                  placeholder="Add any notes about this return processing..."></textarea>
                        <div class="form-text">
                            These notes will be added to the return record and visible in the history.
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'sale_return_detail' sale_return.id %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Details
                        </a>
                        
                        <div class="btn-group">
                            <button type="button" class="btn btn-warning" id="previewBtn">
                                <i class="fas fa-eye"></i> Preview Changes
                            </button>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-check"></i> Process Return
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Status Information Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history"></i> Current Status
                </h5>
            </div>
            <div class="card-body">
                <div class="status-flow">
                    <div class="status-step {% if sale_return.status != 'rejected' %}active{% endif %} {% if sale_return.status == 'pending' %}current{% endif %}">
                        <div class="step-marker">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="step-content">
                            <h6>Pending</h6>
                            <small class="text-muted">Return request submitted</small>
                        </div>
                    </div>
                    
                    <div class="status-step {% if sale_return.status == 'approved' or sale_return.status == 'completed' %}active{% endif %} {% if sale_return.status == 'approved' %}current{% endif %}">
                        <div class="step-marker">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="step-content">
                            <h6>Approved</h6>
                            <small class="text-muted">Return approved for processing</small>
                        </div>
                    </div>
                    
                    <div class="status-step {% if sale_return.status == 'completed' %}active{% endif %} {% if sale_return.status == 'completed' %}current{% endif %}">
                        <div class="step-marker">
                            <i class="fas fa-check-double"></i>
                        </div>
                        <div class="step-content">
                            <h6>Completed</h6>
                            <small class="text-muted">Return fully processed</small>
                        </div>
                    </div>
                    
                    <div class="status-step {% if sale_return.status == 'rejected' %}active current{% endif %}">
                        <div class="step-marker">
                            <i class="fas fa-times"></i>
                        </div>
                        <div class="step-content">
                            <h6>Rejected</h6>
                            <small class="text-muted">Return request rejected</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Summary Card -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calculator"></i> Financial Summary
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless">
                    <tr>
                        <th>Total Return Value:</th>
                        <td class="text-end">৳{{ sale_return.refund_amount }}</td>
                    </tr>
                    {% if sale_return.return_type == 'product' %}
                    <tr>
                        <th>Exchange Value:</th>
                        <td class="text-end">৳{{ sale_return.exchange_product_value }}</td>
                    </tr>
                    <tr class="table-{% if sale_return.balance_amount > 0 %}success{% elif sale_return.balance_amount < 0 %}warning{% else %}info{% endif %}">
                        <th class="fw-bold">Balance Amount:</th>
                        <td class="text-end fw-bold">
                            ৳{{ sale_return.balance_amount|abs }}
                            {% if sale_return.balance_amount > 0 %}
                            <small class="text-success">(Refund)</small>
                            {% elif sale_return.balance_amount < 0 %}
                            <small class="text-warning">(Payment Due)</small>
                            {% else %}
                            <small class="text-info">(Equal)</small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </table>
                
                {% if sale_return.return_type == 'product' and sale_return.balance_amount != 0 %}
                <div class="alert alert-{% if sale_return.balance_amount > 0 %}success{% else %}warning{% endif %} mt-2">
                    <small>
                        <i class="fas fa-{% if sale_return.balance_amount > 0 %}arrow-up{% else %}arrow-down{% endif %}"></i>
                        {% if sale_return.balance_amount > 0 %}
                        Customer will receive ৳{{ sale_return.balance_amount|abs }} refund.
                        {% else %}
                        Customer needs to pay ৳{{ sale_return.balance_amount|abs }} extra.
                        {% endif %}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'generate_invoice' sale_return.sale.invoice_number %}" 
                       class="btn btn-outline-primary" target="_blank">
                        <i class="fas fa-receipt"></i> View Original Invoice
                    </a>
                    
                    <a href="{% url 'sale_return_detail' sale_return.id %}" class="btn btn-outline-info">
                        <i class="fas fa-info-circle"></i> Return Details
                    </a>
                    
                    <a href="{% url 'sale_return_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-list"></i> All Returns
                    </div>
            </div>
        </div>

        <!-- Validation Warnings Card -->
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle"></i> Validation Checks
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    {% if sale_return.return_type == 'product' and not sale_return.exchange_product %}
                    <li class="text-danger mb-2">
                        <i class="fas fa-times-circle"></i> No exchange product selected
                    </li>
                    {% endif %}
                    
                    {% if sale_return.return_type == 'product' and sale_return.exchange_product and not sale_return.can_process_exchange %}
                    <li class="text-danger mb-2">
                        <i class="fas fa-times-circle"></i> Insufficient stock for exchange
                    </li>
                    {% endif %}
                    
                    {% if sale_return.items.count == 0 %}
                    <li class="text-danger mb-2">
                        <i class="fas fa-times-circle"></i> No items in return
                    </li>
                    {% endif %}
                    
                    {% if sale_return.refund_amount <= 0 %}
                    <li class="text-warning mb-2">
                        <i class="fas fa-exclamation-circle"></i> Zero refund amount
                    </li>
                    {% endif %}
                    
                    {% if sale_return.return_type == 'product' and sale_return.exchange_product and sale_return.can_process_exchange %}
                    <li class="text-success mb-2">
                        <i class="fas fa-check-circle"></i> Exchange product available
                    </li>
                    {% endif %}
                    
                    <!-- Balance Validation -->
                    {% if sale_return.return_type == 'product' and sale_return.balance_amount != 0 %}
                    <li class="{% if sale_return.balance_amount > 0 %}text-info{% else %}text-warning{% endif %} mb-2">
                        <i class="fas fa-{% if sale_return.balance_amount > 0 %}arrow-up{% else %}arrow-down{% endif %}"></i>
                        {% if sale_return.balance_amount > 0 %}
                        Customer refund: ৳{{ sale_return.balance_amount|abs }}
                        {% else %}
                        Customer payment: ৳{{ sale_return.balance_amount|abs }}
                        {% endif %}
                    </li>
                    {% endif %}
                    
                    <li class="text-success mb-2">
                        <i class="fas fa-check-circle"></i> Return items validated
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Preview Return Processing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="confirmProcessBtn">
                    <i class="fas fa-check"></i> Confirm & Process
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Debug Section (remove in production) -->
{% if debug %}
<div class="card border-danger mt-4">
    <div class="card-header bg-danger text-white">
        <h5 class="card-title mb-0">Debug Information</h5>
    </div>
    <div class="card-body">
        <pre>Status: {{ sale_return.status }}
Return Type: {{ sale_return.return_type }}
Items Count: {{ sale_return.items.count }}
Exchange Product: {{ sale_return.exchange_product }}
Exchange Quantity: {{ sale_return.exchange_quantity }}
Balance Amount: {{ sale_return.balance_amount }}
Exchange Product Value: {{ sale_return.exchange_product_value }}
Can Process Exchange: {{ sale_return.can_process_exchange }}</pre>
    </div>
</div>
{% endif %}

<style>
.status-flow {
    position: relative;
}

.status-step {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    position: relative;
}

.status-step:last-child {
    margin-bottom: 0;
}

.step-marker {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    background-color: #dee2e6;
    color: #6c757d;
    border: 3px solid #dee2e6;
}

.status-step.active .step-marker {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

.status-step.current .step-marker {
    background-color: #198754;
    border-color: #198754;
    color: white;
}

.status-step:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 20px;
    top: 40px;
    bottom: -20px;
    width: 2px;
    background-color: #dee2e6;
}

.status-step.active:not(:last-child)::after {
    background-color: #0d6efd;
}

.step-content h6 {
    margin-bottom: 2px;
    font-weight: 600;
}

.form-check .card {
    transition: all 0.2s;
    cursor: pointer;
}

.form-check .card:hover {
    border-color: #0d6efd;
    transform: translateY(-2px);
}

.form-check-input:checked + .card {
    border-color: #0d6efd;
    background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Preview button handler
    $('#previewBtn').on('click', function() {
        const selectedAction = $('input[name="action"]:checked').val();
        const notes = $('#notes').val();
        
        let previewHtml = '';
        
        switch(selectedAction) {
            case 'approve':
                previewHtml = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-check-circle"></i> Approve Return</h6>
                        <p class="mb-0">This return will be approved and marked ready for processing.</p>
                    </div>
                `;
                break;
                
            case 'complete':
                previewHtml = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-double"></i> Complete Return</h6>
                        <p class="mb-0">This return will be finalized and stock will be updated.</p>
                    </div>
                    
                    <h6>Stock Changes:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong class="text-success">Stock Added:</strong>
                            <ul>
                                {% for item in sale_return.items.all %}
                                <li>+{{ item.quantity }} {{ item.sale_item.product.name }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% if sale_return.return_type == 'product' and sale_return.exchange_product %}
                        <div class="col-md-6">
                            <strong class="text-danger">Stock Reduced:</strong>
                            <ul>
                                <li>-{{ sale_return.exchange_quantity }} {{ sale_return.exchange_product.name }}</li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if sale_return.return_type == 'product' and sale_return.balance_amount != 0 %}
                    <div class="mt-3">
                        <h6>Financial Impact:</h6>
                        <div class="alert {% if sale_return.balance_amount > 0 %}alert-success{% else %}alert-warning{% endif %}">
                            {% if sale_return.balance_amount > 0 %}
                            <i class="fas fa-arrow-up"></i>
                            <strong>Refund to Customer:</strong> ৳{{ sale_return.balance_amount|abs }} will be refunded.
                            {% else %}
                            <i class="fas fa-arrow-down"></i>
                            <strong>Payment from Customer:</strong> Customer needs to pay ৳{{ sale_return.balance_amount|abs }} extra.
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                `;
                break;
                
            case 'reject':
                previewHtml = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-times-circle"></i> Reject Return</h6>
                        <p class="mb-0">This return request will be rejected and no further action will be taken.</p>
                    </div>
                `;
                break;
        }
        
        if (notes) {
            previewHtml += `
                <div class="mt-3">
                    <h6>Processing Notes:</h6>
                    <div class="p-3 bg-light rounded">${notes}</div>
                </div>
            `;
        }
        
        $('#previewContent').html(previewHtml);
        $('#previewModal').modal('show');
    });
    
    // Confirm process button
    $('#confirmProcessBtn').on('click', function() {
        $('#processForm').submit();
    });
    
    // Form validation
    $('#processForm').on('submit', function(e) {
        const selectedAction = $('input[name="action"]:checked').val();
        
        if (!selectedAction) {
            e.preventDefault();
            alert('Please select an action to proceed.');
            return false;
        }
        
        // Additional validation for product exchange
        if (selectedAction === 'complete' && '{{ sale_return.return_type }}' === 'product') {
            {% if not sale_return.exchange_product %}
            e.preventDefault();
            alert('Cannot complete product exchange return without an exchange product selected.');
            return false;
            {% elif not sale_return.can_process_exchange %}
            e.preventDefault();
            alert('Cannot complete exchange due to insufficient stock. Please adjust the exchange quantity or select a different product.');
            return false;
            {% endif %}
        }
        
        // Show loading
        showGlobalLoading(true);
    });
    
    // Auto-select appropriate action based on current status
    {% if sale_return.status == 'pending' %}
    $('input[name="action"][value="approve"]').prop('checked', true);
    {% elif sale_return.status == 'approved' %}
    $('input[name="action"][value="complete"]').prop('checked', true);
    {% endif %}
});
</script>
{% endblock %}